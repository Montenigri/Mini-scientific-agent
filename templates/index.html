<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MINI SCIENTIFIC AGENT</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="flex h-screen bg-gray-100">
  <div class="m-auto w-full max-w-2xl bg-white rounded-2xl shadow-lg flex flex-col h-[90vh]">
    <!-- Header -->
    <div class="p-4 border-b bg-blue-600 text-white rounded-t-2xl">
      <h1 class="text-lg font-semibold">Mini scientific agent</h1>
    </div>

    <!-- Messaggi -->
    <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-3"></div>

    <!-- Input -->
    <div class="p-4 border-t flex space-x-2">
      <input
        id="chat-input"
        type="text"
        placeholder="Scrivi un messaggio..."
        class="flex-1 px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
      <button
        id="send-btn"
        class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700"
      >
        Invia
      </button>
    </div>
  </div>

  <script>
  const chatBox = document.getElementById("chat-box");
  const chatInput = document.getElementById("chat-input");
  const sendBtn = document.getElementById("send-btn");

  // âœ… Messaggio di sistema predefinito
  let messages = [
    {
      role: "system",
      content:
        "Use all the tool you are provided with starting from RAG and fallback on web search, provide the user with an answer and reference"
    }
  ];

  function addMessage(role, content) {
    const wrapper = document.createElement("div");
    wrapper.className =
      "flex " + (role === "user" ? "justify-end" : "justify-start");

    const bubble = document.createElement("div");
    bubble.className =
      "px-4 py-2 rounded-2xl max-w-xs text-sm whitespace-pre-line " +
      (role === "user"
        ? "bg-blue-500 text-white rounded-br-none"
        : "bg-gray-200 text-gray-800 rounded-bl-none");

    bubble.textContent = content;
    wrapper.appendChild(bubble);
    chatBox.appendChild(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;
    return bubble;
  }

  function createAssistantBubble() {
    const wrapper = document.createElement("div");
    wrapper.className = "flex justify-start";

    const bubble = document.createElement("div");
    bubble.className =
      "px-4 py-2 rounded-2xl max-w-xs text-sm whitespace-pre-line bg-gray-200 text-gray-800 rounded-bl-none";
    wrapper.appendChild(bubble);

    chatBox.appendChild(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;
    return bubble;
  }

  function createThinkingBubble() {
    const wrapper = document.createElement("div");
    wrapper.className = "flex justify-start";

    const details = document.createElement("details");
    details.className =
      "mt-2 bg-yellow-100 border border-yellow-300 rounded p-2 text-sm";

    const summary = document.createElement("summary");
    summary.textContent = "ðŸ¤” Thinking...";
    details.appendChild(summary);

    const contentDiv = document.createElement("div");
    contentDiv.className = "mt-1 whitespace-pre-line text-gray-600";
    details.appendChild(contentDiv);

    wrapper.appendChild(details);
    chatBox.appendChild(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;

    return { details, summary, contentDiv };
  }

  async function sendMessage() {
    const text = chatInput.value.trim();
    if (!text) return;

    messages.push({ role: "user", content: text });
    addMessage("user", text);
    chatInput.value = "";

    const responseBubble = createAssistantBubble();

    let inThink = false;
    let thinkBuffer = "";
    let thinkingBubble = null;

    try {
      const res = await fetch("/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages }),
      });

      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let done = false;

      while (!done) {
        const { value, done: readerDone } = await reader.read();
        done = readerDone;
        if (value) {
          const chunk = decoder.decode(value, { stream: true });
          let remaining = chunk;

          while (remaining.length > 0) {
            if (!inThink) {
              const thinkStart = remaining.indexOf("<think>");
              if (thinkStart !== -1) {
                responseBubble.textContent += remaining.slice(0, thinkStart);
                remaining = remaining.slice(thinkStart + 7);
                inThink = true;

                if (!thinkingBubble) {
                  thinkingBubble = createThinkingBubble();
                }
                thinkBuffer = "";
              } else {
                responseBubble.textContent += remaining;
                remaining = "";
              }
            } else {
              const thinkEnd = remaining.indexOf("</think>");
              if (thinkEnd !== -1) {
                thinkBuffer += remaining.slice(0, thinkEnd);
                remaining = remaining.slice(thinkEnd + 8);
                inThink = false;

                // Aggiorna contenuto finale del thinking
                thinkingBubble.contentDiv.textContent = thinkBuffer;
                thinkingBubble.summary.textContent =
                  "ðŸ¤” Thinking (clicca per aprire)";
                thinkBuffer = "";
              } else {
                thinkBuffer += remaining;
                remaining = "";
                if (thinkingBubble)
                  thinkingBubble.contentDiv.textContent = thinkBuffer;
              }
            }
          }

          chatBox.scrollTop = chatBox.scrollHeight;
        }
      }

      messages.push({ role: "assistant", content: responseBubble.textContent });
    } catch (err) {
      responseBubble.textContent = "âŒ Errore nella connessione all'IA";
    }
  }

  sendBtn.addEventListener("click", sendMessage);
  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") sendMessage();
  });
  </script>
</body>
</html>
